FROM golang:1.23-alpine

RUN apk update && apk upgrade && \
    apk add --no-cache bash git openssh make protobuf-dev \
    && rm -rf /var/cache/apk/*

WORKDIR /app


COPY go.mod ./
RUN go mod download
RUN go get -u github.com/go-sql-driver/mysql
RUN go get github.com/gorilla/mux

COPY . .

RUN go mod tidy
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@latest \
    && go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

RUN protoc --proto_path=protobuf "protobuf/users.proto" \
		--go_out=internal/services/common/genproto/users --go_opt=paths=source_relative \
  	--go-grpc_out=internal/services/common/genproto/users --go-grpc_opt=paths=source_relative

RUN go build  -mod=mod -o main ./cmd/ums/main.go



EXPOSE 8081

CMD ["./main"]
